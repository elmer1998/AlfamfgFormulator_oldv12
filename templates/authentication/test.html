{% extends "admin.html" %}
{% load static %}

{% block title %}{% endblock %}

{% block content %}

    <div class="container">
        <div class="page-inner">

            <div class="row">
                <div class="col-md-12">
                    <div class="card card-round">
                        <div class="card-header">

                            <div class="card-head-row card-tools-still-right">
                                <h4 class="card-title">ALL PARTS CATEGORY </h4>

                                <div class="card-tools">

                                    <button class="btn btn-icon btn-link btn-primary btn-xs btn-refresh-card">
                                        <span class="fa fa-sync-alt"></span>
                                    </button>

                                    <button class="btn btn-icon btn-link btn-primary btn-xs d-none">
                                        <span class="fa fa-times"></span>
                                    </button>

                                </div>
                            </div>

                            <p class="card-category d-none">
                                Displays the Finished Goods, Raw Materials and Packaging Category
                            </p>
                        </div>

                        <div class="card-body">
                            <div class="row">

                                <div class="col-md-4">
                                    
                                    <div class="d-none">
                                        <div class="form-group d-flex align-items-center">
                                            <label for="search_partnum" class="me-2" style="min-width: 100px;">Part Number</label>
                                            <input type="text" class="form-control" id="search_partnum" />
                                        </div>
                                        
                                        <div class="form-group d-flex align-items-center">
                                            <label for="search_description" class="me-2" style="min-width: 100px;">Description</label>
                                            <input type="text" class="form-control" id="search_description"/>
                                        </div>
    
                                        <div class="d-flex justify-content-end">
                                            <button class="btn btn-primary btn-border me-3" id="search_button">Search</button>
                                        </div>
                                        
                                        <hr>
                                    </div>

                                    <div class="table-responsive main_table">
                                        <table class="table display table-hover" id="main_table">
                                            <thead>
                                                <tr>
                                                    <th scope="col"><span>Part Number</span></th>
                                                    <th scope="col"><span>Part Description</span></th>
                                                </tr>
                                            </thead>
                                        
                                            <tbody>
                                                {% for parts_inventory in parts_inventories %}
                                                    {% if parts_inventory.default_vendor_parts %}
                                                        {% for vendor_part in parts_inventory.default_vendor_parts %}

                                                            <tr data-part-id="{{ parts_inventory.id }}"
                                                                data-partnum="{{ parts_inventory.part_num }}"
                                                                data-trade-name="{{ parts_inventory.trade_name }}"
                                                                data-description="{{ parts_inventory.description }}"
                                                                data-manufacturer-name="{{ parts_inventory.manufacturer_name }}"
                                                                data-inventory-category="{{ parts_inventory.inventory_category }}"
                                                                data-notes="{{ parts_inventory.notes }}"
                                                                data-current-cost="{{ parts_inventory.std_cost }}"
                                                                data-vendor="{{ vendor_part.vendor.vendor_name }}"
                                                            >
                                                                
                                                                <td>
                                                                    {{ parts_inventory.part_num }}
                                                                </td>

                                                                <td title="{{ parts_inventory.description }}">
                                                                    {{ parts_inventory.description }}
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                        {% else %}
                                                            <tr data-part-id="{{ parts_inventory.id }}"
                                                                data-partnum="{{ parts_inventory.part_num }}"
                                                                data-trade-name="{{ parts_inventory.trade_name }}"
                                                                data-description="{{ parts_inventory.description }}"
                                                                data-manufacturer-name="{{ parts_inventory.manufacturer_name }}"
                                                                data-inventory-category="{{ parts_inventory.inventory_category }}"
                                                                data-notes="{{ parts_inventory.notes }}"
                                                                data-current-cost="{{ parts_inventory.std_cost }}"
                                                                data-vendor="{{ vendor_part.vendor.vendor_name }}"
                                                            >
                                                                
                                                                <td>
                                                                    {{ parts_inventory.part_num }}
                                                                </td>

                                                                <td>
                                                                    {{ parts_inventory.description }}
                                                                </td>
                                                            </tr>
                                                        {% endif %}
                                                {% endfor %}
                                            </tbody>
                                        </table>                                       
                                    </div>
                                </div>

                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header d-flex align-items-center justify-content-between" style="background-color: darkblue;">
                                            <p class="card-title text-light d-none">Parts Details: <span class="ms-1" id="header-partnum"></span> <span id="dashes"></span> <span id="header-description"></span></p>    
                                        </div>                                    

                                        <div class="card-body">
                                            <ul class="nav nav-pills nav-secondary" id="pills-tab" role="tablist">
                                                <li class="nav-item li_general">
                                                    <a class="nav-link active" id="pills-general-tab" data-bs-toggle="pill" href="#pills-general" role="tab" aria-controls="pills-general" aria-selected="true">General</a>
                                                </li>
                                                <li class="nav-item li_costing">
                                                    <a class="nav-link" id="pills-costing-tab" data-bs-toggle="pill" href="#pills-costing" role="tab" aria-controls="pills-costing" aria-selected="false">Costing</a>
                                                </li>
                                        </div>
                                        
                                    </div>
                                </div>

                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Script -->
    <script>
        $(document).ready(function() { 
            //========================================================================================================================================

                $('input, textarea').prop('disabled', true);

                $('li.sidebar_parts_inventory').addClass('active');
                $('div#parts_inventory_nav').addClass('show');
                $('div#parts_inventory_nav ul li.li_parts_inventory').addClass('active');

                $('button#add_inventory').css('visibility', 'hidden');

            //========================================================================================================================================
                
                $('#pills-technical-specs-tab').on('click', function(e) {
                    if ($(this).hasClass('disabled')) {
                        e.preventDefault(); 
                        e.stopPropagation();
                    }
                });

                var selectedPartId;
                var selectedVendorPartsId;

                $('#main_table tbody').on('click', 'tr', function() {
                    
                    $('p.card-title').removeClass('d-none');

                    $('input.documents').prop('disabled', false);

                    $('#main_table tbody tr').removeClass('table-active');
                    $(this).addClass('table-active');

                    $('li.vendor a.nav-link').removeClass('disabled');
                    $('#add_inventory').addClass('d-none');

                    //$('.btn-group').removeClass('d-none');
                    
                    $('li.vendor').removeClass('d-none');
                    $('li.li_technical_specs').removeClass('d-none');
                    $('li.li_documents').removeClass('d-none');

                    var partnum = $(this).data('partnum');
                    var partId = $(this).data('part-id');
                    var partIdVendor = $(this).data('part-id');
                    var description = $(this).data('description');
                    var trade_name = $(this).data('trade-name');
                    var vendorName = $(this).data('vendor-name');
                    var vendorId = $(this).data('vendor-id');
                    var vendor = $(this).data('vendor');
                    var manufacturerName = $(this).data('manufacturer-name');
                    var inventoryCategory = $(this).data('inventory-category');
                    var notes = $(this).data('notes');
                    var currentCost = $(this).data('current-cost');
                    var dashes;

                    if(description != "") {
                        dashes = "-";
                    } else {
                        dashes = null;
                    }
                    
                    $('#partId').val(partId);
                    $('#partId_inci').val(partId);
                    $('#partId_vendor').val(partIdVendor);
                    $('#partnum').val(partnum);
                    $('#header-partnum').text(partnum);
                    $('#dashes').text(dashes);
                    $('#description').val(description === 'None' ? '' : description);
                    $('#header-description').text(description);
                    //$('#trade_name').val();
                    $('#vendor_name').val(vendor);
                    $('#vendor_id').val(vendorId);
                    $('#manufacturer_name').val(manufacturerName);
                    $('#inventory_category').val(inventoryCategory);
                    $('#notes').val(notes !== 'None' && notes ? notes : '');
                    $('#current_cost').val(currentCost !== 'None' && currentCost ? parseFloat(currentCost).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '');

                    selectedPartId = partId;
                    
                    if(inventoryCategory === 'RAW MATERIALS') {
                        $('li.li_technical_specs').removeClass('d-none');
                    } else {
                        $('li.li_technical_specs').addClass('d-none');
                    }
                 
                    $.ajax({
                        url: '/parts/part/' + partId + '/ingredients/inci_name',
                        method: 'GET',
                        success: function(response) {
                            var tbody = $('#technical-table tbody');
                            tbody.empty();
                            
                            var ingredient_list = [];
                            
                            if (response.length > 0) {
                                $.each(response, function(index, ingredients) {
                                    var row = 
                                        '<tr class="center-align">' +
                                            '<td>' + (index + 1) + '.' + '</td>' + // Add the numbering here
                                            '<td class="left-align">' + ingredients.name + '</td>' +
                                            '<td></td>' +
                                            '<td></td>' +
                                            '<td><div class="delete-part-ingredients" data-ingredient-id="' + ingredients.id + '">' +
                                                '<button class="btn btn-danger btn-sm delete_ingredients" type="button">Remove</button>' +
                                            '</div></td>' +
                                        '</tr>';
                                        
                                    tbody.append(row);
                                    ingredient_list.push(ingredients.name);

                                });
                            } else {
                                tbody.append('<tr><td colspan="4" class="text-center">No Ingredients found for this part.</td></tr>');
                            }

                            $('#ingredients_list').val(ingredient_list.join(' â€¢ '));

                        },
                        error: function(xhr, status, error) {
                            console.log('Error:', error);
                            $('#loading-indicator').hide();
                            swal({
                                title: "Error",
                                text: "An error occurred.",
                                icon: "error",
                                buttons: {
                                    confirm: {
                                        className: "btn btn-danger",
                                    },
                                },
                            }).then(() => {
                                setTimeout(function() {
                                    location.reload(); 
                                }, 1000); 
                            });
                        }
                    });

                    $.ajax({
                        url: '/parts/part/' + partId + '/ingredients/allergens',
                        method: 'GET',
                        success: function(response) {
                            var tbody = $('#allergens-table tbody');
                            tbody.empty();
                            
                            var ingredient_list = [];
                            
                            if (response.length > 0) {
                                $.each(response, function(index, ingredients) {
                                    var row = 
                                        '<tr class="center-align">' +
                                            '<td>' + (index + 1) + '.' + '</td>' + 
                                            '<td class="left-align">' + ingredients.name + '</td>' +
                                            '<td></td>' +
                                            '<td></td>' +
                                            '<td><div class="delete-part-ingredients" data-ingredient-id="' + ingredients.id + '">' +
                                                '<button class="btn btn-danger btn-sm delete_ingredients" type="button">Remove</button>' +
                                            '</div></td>' +
                                        '</tr>';
                                        
                                    tbody.append(row);
                                    ingredient_list.push(ingredients.name);

                                });
                            } else {
                                tbody.append('<tr><td colspan="4" class="text-center">No Ingredients found for this part.</td></tr>');
                            }

                        },
                        error: function(xhr, status, error) {
                            console.log('Error:', error);
                            $('#loading-indicator').hide();
                            swal({
                                title: "Error",
                                text: "An error occurred.",
                                icon: "error",
                                buttons: {
                                    confirm: {
                                        className: "btn btn-danger",
                                    },
                                },
                            }).then(() => {
                                setTimeout(function() {
                                    location.reload(); 
                                }, 1000); 
                            });
                        }
                    });

                    $.ajax({
                        url: '/parts/part/' + partId + '/ingredients/impurities',
                        method: 'GET',
                        success: function(response) {
                            var tbody = $('#impurities-table tbody');
                            tbody.empty();
                            
                            var ingredient_list = [];
                            
                            if (response.length > 0) {
                                $.each(response, function(index, ingredients) {
                                    var row = 
                                        '<tr class="center-align">' +
                                            '<td>' + (index + 1) + '.' + '</td>' + 
                                            '<td class="left-align">' + ingredients.name + '</td>' +
                                            '<td></td>' +
                                            '<td></td>' +
                                            '<td><div class="delete-part-ingredients" data-ingredient-id="' + ingredients.id + '">' +
                                                '<button class="btn btn-danger btn-sm delete_ingredients" type="button">Remove</button>' +
                                            '</div></td>' +
                                        '</tr>';
                                        
                                    tbody.append(row);
                                    ingredient_list.push(ingredients.name);

                                });
                            } else {
                                tbody.append('<tr><td colspan="4" class="text-center">No Ingredients found for this part.</td></tr>');
                            }
                        },
                        error: function(xhr, status, error) {
                            console.log('Error:', error);
                            $('#loading-indicator').hide();
                            swal({
                                title: "Error",
                                text: "An error occurred.",
                                icon: "error",
                                buttons: {
                                    confirm: {
                                        className: "btn btn-danger",
                                    },
                                },
                            }).then(() => {
                                setTimeout(function() {
                                    location.reload(); 
                                }, 1000); 
                            });
                        }
                    });


                    $.ajax({
                        url: '/admin_helpers/part_vendor/' + partId + '/', 
                        type: 'GET',
                        success: function(response) {
                            console.log('response: ', response);
                            var tbody = $('#vendor-table tbody');
                            tbody.empty();
                            
                            var vendorSelect = $('#vendor_select_for_docs');
                            vendorSelect.empty(); 
                            
                            var VendorSelectFormModal = $('#vendor_select_for_docs_modal');
                            VendorSelectFormModal.empty(); 

                            VendorSelectFormModal.append(new Option('Select Vendor', ''));

                            var vendorDocumentChecklists = $('#vendor-document-checklists');
                            vendorDocumentChecklists.empty();

                            var vendorparts_list = [];
                            
                            if (response.length > 0) {
                                $.each(response, function(index, vendorparts) {
                                    var vendorLastCost = parseFloat(vendorparts.lastcost).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                                    var row = 
                                        '<tr>' +
                                            '<td>' + (index + 1) + '.' + '</td>' + // Add the numbering here
                                            '<td>' + vendorparts.vendor_name + '</td>' +
                                            '<td>' + '$' + vendorLastCost + '</td>' +
                                            '<td></td>' +
                                            '<td></td>' +
                                            '<td></td>' +
                                            '<td></td>' +
                                            '<td>' + vendorparts.vendor_partnum + '</td>' +
                                            '<td class="center-align">' + (vendorparts.leadtime ? vendorparts.leadtime : '') + '</td>' +
                                            '<td><div class="d-none delete-part-vendor-name" data-vendor-id="' + vendorparts.vendor_id + '">' +
                                                '<button class="btn btn-danger btn-sm delete_vendor" type="button">Remove</button>' +
                                            '</div></td>' +
                                            '</tr>';
                                        
                                    tbody.append(row);
                                    vendorSelect.append(new Option(vendorparts.vendor_name, vendorparts.vendor_id));
                                    VendorSelectFormModal.append(new Option(vendorparts.vendor_name, vendorparts.vendor_id));

                                    var checklistHtml = `
                                        <div class="accordion-item">
                                            <h2 class="accordion-header" id="heading_${vendorparts.vendor_id}">
                                                <button class="accordion-button collapsed ms-4" type="button" data-bs-toggle="collapse" data-bs-target="#collapse_${vendorparts.vendor_id}" aria-expanded="false" aria-controls="collapse_${vendorparts.vendor_id}">
                                                <i class="icon-arrow-down fas fa-chevron-down"></i>
                                                <i class="icon-arrow-up fas fa-chevron-up d-none"></i>
                                                <span class="ms-5" style="font-weight: bold;">${vendorparts.vendor_name}</span>
                                                </button>
                                            </h2>
                                            <div id="collapse_${vendorparts.vendor_id}" class="accordion-collapse collapse" aria-labelledby="heading_${vendorparts.vendor_id}" data-bs-parent="#vendorDocumentChecklists">
                                                <div class="accordion-body">
                                                    <br>
                                                    <div class="table-responsive">
                                                        <table class="table table-bordered" id="document-table">
                                                            <thead>
                                                                <tr>
                                                                    <th>Document Name</th>
                                                                    <th>File Name</th>
                                                                    <th class="center-align">Approved</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr class="${vendorparts.documents.some(doc => doc.type === 'Technical Data Sheet') ? 'has-file' : ''}">
                                                                    <td>Technical Data Sheet</td>
                                                                    <td>
                                                                        ${vendorparts.documents.find(doc => doc.type === 'Technical Data Sheet')?.file || 'No file uploaded'}
                                                                        <i class="fas fa-download float-end"></i>
                                                                    </td>
                                                                    <td class="d-none"><img src="{% static 'assets/img/check.jpg' %}" alt="check" class="d-none" width="30" height="30" id="tds_${vendorparts.vendor_id}"/></td>
                                                                    <td class="center-align"><input type="checkbox" name="status"></td>
                                                                </tr>
                                                                <tr class="${vendorparts.documents.some(doc => doc.type === 'Safety Data Sheet (SDS)') ? 'has-file' : ''}">
                                                                    <td>Safety Data Sheet (SDS)</td>
                                                                    <td>
                                                                        ${vendorparts.documents.find(doc => doc.type === 'Safety Data Sheet (SDS)')?.file || 'No file uploaded'}
                                                                        <i class="fas fa-download float-end"></i>
                                                                    </td>
                                                                    <td class="d-none"><img src="{% static 'assets/img/check.jpg' %}" alt="check" class="d-none" width="30" height="30" id="sds_${vendorparts.vendor_id}"/></td>
                                                                    <td class="center-align"><input type="checkbox" name="status"></td>
                                                                </tr>
                                                                <tr class="${vendorparts.documents.some(doc => doc.type === 'Material Questionnaire') ? 'has-file' : ''}">
                                                                    <td>Material Questionnaire</td>
                                                                    <td>
                                                                        ${vendorparts.documents.find(doc => doc.type === 'Material Questionnaire')?.file || 'No file uploaded'}
                                                                        <i class="fas fa-download float-end"></i>
                                                                    </td>
                                                                    <td class="d-none"><img src="{% static 'assets/img/check.jpg' %}" alt="check" class="d-none" width="30" height="30" id="mq_${vendorparts.vendor_id}"/></td>
                                                                    <td class="center-align"><input type="checkbox" name="status"></td>
                                                                </tr>
                                                                <tr class="${vendorparts.documents.some(doc => doc.type === 'Composition Statement') ? 'has-file' : ''}">
                                                                    <td>Composition Statement</td>
                                                                    <td>
                                                                        ${vendorparts.documents.find(doc => doc.type === 'Composition Statement')?.file || 'No file uploaded'}
                                                                        <i class="fas fa-download float-end"></i>
                                                                    </td>
                                                                    <td class="d-none"><img src="{% static 'assets/img/check.jpg' %}" alt="check" class="d-none" width="30" height="30" id="cs_${vendorparts.vendor_id}"/></td>
                                                                    <td class="center-align"><input type="checkbox" name="status"></td>
                                                                </tr>
                                                                <tr class="${vendorparts.documents.some(doc => doc.type === 'No Animal Testing') ? 'has-file' : ''}">
                                                                    <td>No Animal Testing</td>
                                                                    <td>
                                                                        ${vendorparts.documents.find(doc => doc.type === 'No Animal Testing')?.file || 'No file uploaded'}
                                                                        <i class="fas fa-download float-end"></i>
                                                                    </td>
                                                                    <td class="d-none"><img src="{% static 'assets/img/check.jpg' %}" alt="check" class="d-none" width="30" height="30" id="nat_${vendorparts.vendor_id}"/></td>
                                                                    <td class="center-align"><input type="checkbox" name="status"></td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div><hr>
                                    `;
                                
                                    vendorDocumentChecklists.append(checklistHtml);

                                    $(document).on('click', '.accordion-button', function() {
                                        const chevronDown = $(this).find('.icon-arrow-down');
                                        const chevronUp = $(this).find('.icon-arrow-up');
                                        chevronDown.toggleClass('d-none');
                                        chevronUp.toggleClass('d-none');
                                    });

                                    vendorparts.documents.forEach(function(document) {
                                        console.log('Document type: ', document.type, 'File: ', document.file);
                                        var typeToIdMap = {
                                            'Technical Data Sheet': '#tds_' + vendorparts.vendor_id,
                                            'Safety Data Sheet (SDS)': '#sds_' + vendorparts.vendor_id,
                                            'Material Questionnaire': '#mq_' + vendorparts.vendor_id,
                                            'Composition Statement': '#cs_' + vendorparts.vendor_id,
                                            'No Animal Testing': '#nat_' + vendorparts.vendor_id
                                        };

                                        var elementId = typeToIdMap[document.type];
                                        if (elementId) {
                                           // $(elementId).removeClass('d-none');
                                        }
                                    });
                                });
                            } else {
                                tbody.append('<tr><td colspan="11" class="text-center">No Associated Vendors found for this part.</td></tr>');
                            }
                            
                        },
                        error: function(xhr, status, error) {
                            $('#loading-indicator').hide();
                            swal({
                                title: "Error",
                                text: "An error occurred",
                                icon: "error",
                                buttons: {
                                    confirm: {
                                        className: "btn btn-danger",
                                    },
                                },
                            }).then(() => {
                                setTimeout(function() {
                                    location.reload(); 
                                }, 1000); 
                            });
                        }
                    });
                 
                    $.ajax({
                        url: '/admin_helpers/get_available_vendors_for_specific_parts', 
                        data: {
                            'part_id': partId
                        },
                        success: function(data) {
                            const vendorSelect = $('#vendor_id'); 
                            vendorSelect.empty(); 
                
                            if (data.vendors.length > 0) {
                                data.vendors.forEach(function(vendor) {
                                    vendorSelect.append(new Option(vendor.vendor_name, vendor.id));
                                });
                            } else {
                                vendorSelect.append(new Option('No available vendors', ''));
                            }
                        },
                        error: function(xhr, status, error) {
                            $('#loading-indicator').hide();
                            swal({
                                title: "Error",
                                text: "An error occurred.",
                                icon: "error",
                                buttons: {
                                    confirm: {
                                        className: "btn btn-danger",
                                    },
                                },
                            }).then(() => {
                                setTimeout(function() {
                                    location.reload(); 
                                }, 1000); 
                            });
                        }
                    });

                });

            //========================================================================================================================================
          
                $('#add_inventory').click(function(e) {
                    e.preventDefault();
                    
                    var partNum = $('#partnum').val();

                    if (!partNum) {
                        swal("Error", "Part Number is required", {
                            icon: "error",
                            buttons: {
                                confirm: {
                                    className: "btn btn-danger",
                                },
                            },
                        });

                        return;
                    }
                    
                    var trade_name = $('#trade_name').val();
                    var description = $('#description').val();
                    var userId = $('#userId').val();
                    var vendorId = $('#vendor_id').val();
                    var manufacturerName = $('#manufacturer_name').val();
                    var inventory_category = $('#inventory_category').val();
                    var notes = $('#notes').val();
                    var currentCost = $('#current_cost').val();

                    $('#loading-indicator').show(); 

                    $.ajax({
                        url: '{% url "add_part" %}',
                        type: 'POST',
                        data: {
                            'part_num': partNum,
                            'trade_name': trade_name,
                            'description': description,
                            'manufacturer_name': manufacturerName,
                            'inventory_category': inventory_category,
                            'notes': notes,
                            'user_id': userId,
                            'current_cost': currentCost,
                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                        },
                        success: function(response) {
                            swal("Success!", " Part succesfully added", {
                                icon: "success",
                                buttons: {
                                    confirm: {
                                        className: "btn btn-success",
                                    },
                                },
                            }).then(() => {
                                setTimeout(function() {
                                    location.reload(); 
                                }, 1000); 
                            });
                        },
                        error: function(xhr, status, error) {
                            console.log('error: ', error)
                            $('#loading-indicator').hide();
                            swal({
                                title: "Error",
                                text: "An error occurred while trying to add the part.",
                                icon: "error",
                                buttons: {
                                    confirm: {
                                        className: "btn btn-danger",
                                    },
                                },
                            }).then(() => {
                                setTimeout(function() {
                                    location.reload(); 
                                }, 1000); 
                            });
                        },
                        complete: function() {
                            setTimeout(function() {
                                $('#loading-indicator').hide();
                            }, 3000); 
                        },
                    });
                });

            //========================================================================================================================================
          
                 $('#update_inventory').click(function(e) {
                    e.preventDefault();
                    
                    var partId = $('#partId').val();
                    var partNum = $('#partnum').val();

                    if (!partNum) {
                        swal("Error", "Part Number is required", {
                            icon: "error",
                            buttons: {
                                confirm: {
                                    className: "btn btn-danger",
                                },
                            },
                        });

                        return;
                    }
                    
                    var description = $('#description').val();
                    var trade_name = $('#trade_name').val();
                    var manufacturerName = $('#manufacturer_name').val();
                    var inventoryCategory = $('#inventory_category').val();
                    var notes = $('#notes').val();
                    var user_id = $('#userId').val();
                    var currentCost = $('#current_cost').val();
                    console.log('user_id: ', user_id);

                    $('#loading-indicator').show(); 

                    $.ajax({
                        url: '{% url "update_parts" %}',
                        type: 'POST',
                        data: {
                            'num': partNum,
                            'description': description,
                            'trade_name': trade_name,
                            'manufacturer_name': manufacturerName,
                            'inventory_category': inventoryCategory,
                            'notes': notes,
                            'part_id' : partId,
                            'user_id' : user_id,
                            'current_cost': currentCost,
                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                        },
                        success: function(response) {
                            swal("Success!", " Part succesfully updated", {
                                icon: "success",
                                buttons: {
                                    confirm: {
                                        className: "btn btn-success",
                                    },
                                },
                            }).then(() => {
                                setTimeout(function() {
                                    location.reload(); 
                                }, 2000); 
                            });
                        },
                        error: function(xhr, status, error) {
                            $('#loading-indicator').hide();
                            console.log('error: ', error)

                            swal({
                                title: "Error",
                                text: "An error occurred while trying to update the part.",
                                icon: "error",
                                buttons: {
                                    confirm: {
                                        className: "btn btn-danger",
                                    },
                                },
                            });
                        },
                        complete: function() {
                            setTimeout(function() {
                                $('#loading-indicator').hide();
                            }, 3000); 
                        }
                    });
                });
          
            //========================================================================================================================================

                $('#delete_inventory').click(function(e) {
                    e.preventDefault(); 
            
                    swal({
                        title: "Are you sure?",
                        text: "You won't be able to revert this!",
                        icon: "warning",
                        buttons: {
                            confirm: {
                                text: "Yes, delete it!",
                                className: "btn btn-success",
                            },
                            cancel: {
                                visible: true,
                                className: "btn btn-danger",
                            },
                        },
                    }).then((Delete) => {
                        if (Delete) {
                            $('#loading-indicator').show();
                
                            var url = '/parts/delete_part/' + selectedPartId + '/'; 
                
                            $.ajax({
                                url: url,
                                type: 'POST', 
                                data: {
                                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                                },
                                success: function(response) {
                                    setTimeout(function() {
                                        $('#loading-indicator').hide();
                
                                        swal({
                                            title: "Deleted!",
                                            text: "Part has been deleted.",
                                            icon: "success",
                                            buttons: {
                                                confirm: {
                                                    className: "btn btn-success",
                                                },
                                            },
                                            timer: 3000 
                                        }).then(() => {
                                            location.reload(); 
                                        });
                                    }, 500); 
                                },
                                error: function(xhr, status, error) {
                                    $('#loading-indicator').hide();
                                    swal({
                                        title: "Error",
                                        text: "An error occurred while trying to delete the part.",
                                        icon: "error",
                                        buttons: {
                                            confirm: {
                                                className: "btn btn-danger",
                                            },
                                        },
                                    });
                                },
                                complete: function() {
                                    setTimeout(function() {
                                        $('#loading-indicator').hide();
                                    }, 3000); 
                                },
                            });
                        } else {
                            swal.close(); 
                        }
                    });
                });
            
            //========================================================================================================================================
                
                $(document).on('click', '.delete_vendor', function() {

                    var button = $(this);
                    var container = button.closest('.delete-part-vendor-name');
                    var vendorId = container.data('vendor-id');
                
                    $('#loading-indicator').show(); 

                    $.ajax({
                        url: '/vendor/delete_vendorparts/' + vendorId + '/', 
                        type: 'POST',
                        data: {
                            csrfmiddlewaretoken: '{{ csrf_token }}',
                        },
                        success: function(response) {
                            container.closest('tr').remove();
                            setTimeout(function() {
                                $('#loading-indicator').hide();
        
                                swal({
                                    title: "Deleted!",
                                    text: "Vendor deleted",
                                    icon: "success",
                                    buttons: {
                                        confirm: {
                                            className: "btn btn-success",
                                        },
                                    },
                                    timer: 3000 
                                }).then(() => {
                                    location.reload(); 
                                });
                            }, 500); 
                        },
                        error: function(xhr, status, error) {
                            $('#loading-indicator').hide();
                            swal({
                                title: "Error",
                                text: "An error occurred while trying to delete the vendor.",
                                icon: "error",
                                buttons: {
                                    confirm: {
                                        className: "btn btn-danger",
                                    },
                                },
                            });
                        },
                        complete: function() {
                            setTimeout(function() {
                                $('#loading-indicator').hide();
                            }, 3000); 
                        }
                    });
                });

                
            //========================================================================================================================================
            
                $('#search_button').click(function() {
                    var partNumber = $('#search_partnum').val().trim().toLowerCase();
                    var description = $('#search_description').val().trim().toLowerCase();
            
                    var matchedRows = [];
            
                    $('#main_table tbody tr').each(function() {
                        var $row = $(this);
                        var rowPartNum = String($row.data('partnum')).toLowerCase();
                        var rowDescription = String($row.data('description')).toLowerCase(); 
            
                        var matchesPartNum = partNumber === '' || rowPartNum.startsWith(partNumber);
                        var matchesDescription = description === '' || rowDescription.startsWith(description);
            
                        if (matchesPartNum && matchesDescription) {
                            $row.show();
                            matchedRows.push({
                                partNumber: rowPartNum,
                                description: rowDescription
                            });
                        } else {
                            $row.hide();
                        }
                    });
            
                    // Log the matched rows to the console
                    console.log('Matched Rows:', matchedRows);
                });
            
            //========================================================================================================================================
                
                $('#vendor_parts_btn').on('click', function(event) {
                    
                    var inputData = {
                        vendor_id: $('#vendor_id').val(),
                        lastcost: $('#last_cost').val(),
                        part_id: $('#partId_vendor').val(),
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    };

                    $('#loading-indicator').show(); 

                    $.ajax({
                        type: 'POST',
                        url: '/vendor/add_vendorparts',
                        data: {
                            vendor_id: $('#vendor_id').val(),
                            lastcost: $('#last_cost').val(),
                            part_id: $('#partId_vendor').val(),
                            userId : $('#userId').val(),
                            csrfmiddlewaretoken: '{{ csrf_token }}',
                        },
                        success: function(response) {
                            setTimeout(function() {
                                $('#loading-indicator').hide();
        
                                swal({
                                    title: "Deleted!",
                                    text: "Vendor Pricing Added",
                                    icon: "success",
                                    buttons: {
                                        confirm: {
                                            className: "btn btn-success",
                                        },
                                    },
                                    timer: 3000 
                                }).then(() => {
                                    location.reload(); 
                                });
                            }, 500); 
                        
                        },
                        error: function(xhr, status, error) {
                            $('#loading-indicator').hide();
                            swal({
                                title: "Error",
                                text: "An error occurred while trying to add the vendor.",
                                icon: "error",
                                buttons: {
                                    confirm: {
                                        className: "btn btn-danger",
                                    },
                                },
                            }).then(() => {
                                setTimeout(function() {
                                    location.reload(); 
                                }, 1000); 
                            });
                        },
                    });

                });
            //========================================================================================================================================
                
                var $fileInput = $("#fileInput");
                var $fileListContainer = $("#fileListContainer");
                var $placeholderText = $("#placeholderText");

                $fileListContainer.on("click", function(event) {
                    if (event.target.id === "fileListContainer" || event.target.id === "placeholderText") {
                        $fileInput.click();
                    }
                });

                $fileInput.on("change", function() {
                    var files = $fileInput[0].files;
                    $fileListContainer.empty(); // Clear previous file list

                    if (files.length > 0) {
                        for (var i = 0; i < files.length; i++) {
                            (function(file, index) {
                                var fileItem = $("<div></div>").addClass("file-item").css({
                                    "display": "flex",
                                    "justify-content": "space-between",
                                    "align-items": "center",
                                    "padding": "5px 0",
                                    "font-size": "12px",
                                });
                                var fileName = $("<span></span>").text(file.name);
                                var removeButton = $("<button>&times;</button>").css({
                                    "background": "none",
                                    "border": "none",
                                    "color": "red",
                                    "cursor": "pointer",
                                    "font-size": "16px",
                                    "font-weight": "bold"
                                });

                                removeButton.on("click", function(event) {
                                    event.stopPropagation(); 
                                    fileItem.remove();

                                    var dt = new DataTransfer();
                                    for (var j = 0; j < files.length; j++) {
                                        if (j !== index) {
                                            dt.items.add(files[j]);
                                        }
                                    }
                                    $fileInput[0].files = dt.files;

                                    if ($fileInput[0].files.length === 0) {
                                        $fileListContainer.append($placeholderText);
                                    }
                                });

                                fileItem.append(fileName).append(removeButton);
                                $fileListContainer.append(fileItem);
                            })(files[i], i);
                        }
                    } else {
                        $fileListContainer.append($placeholderText);
                    }
                });

            //========================================================================================================================================
              
                $("#fileUploadForm").on("submit", function(event) {
                    event.preventDefault(); 
                    
                    var formData = new FormData(this); 
                    let actionUrl = "{% url 'upload_partdocuments' %}";

                    if ($fileInput[0].files.length === 0 && formData) {
                        event.preventDefault();
                        swal({
                            title: "Warning",
                            text: "All fields are required.",
                            icon: "warning",
                            buttons: {
                                confirm: {
                                    className: "btn btn-warning",
                                },
                            },
                        });
                    } else {
                        $('#loading-indicator').show();

                        $.ajax({
                            url: actionUrl,
                            type: 'POST',
                            data: formData,
                            processData: false,
                            contentType: false, 
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            success: function(response) {
                                setTimeout(function() {            
                                    swal({
                                        title: "Upload!",
                                        text: "Upload succesfully",
                                        icon: "success",
                                        buttons: {
                                            confirm: {
                                                className: "btn btn-success",
                                            },
                                        },
                                        timer: 3000 
                                    }).then(() => {
                                        location.reload(); 
                                    });
                                }, 500); 
                            },
                            error: function(xhr, status, error) {
                                $('#loading-indicator').hide();
                                swal({
                                    title: "Error",
                                    text: "An error occurred while trying to upload the file.",
                                    icon: "error",
                                    buttons: {
                                        confirm: {
                                            className: "btn btn-danger",
                                        },
                                    },
                                });
                            },
                            complete: function() {
                                setTimeout(function() {
                                    $('#loading-indicator').hide();
                                }, 3000); 
                            }
                        });
                    }

                });

            //========================================================================================================================================
                
                $('#vendor_select_for_docs_modal').on('change', function() {
                    var vendorparts_id = $(this).val(); 
                
                    $.ajax({
                        url: '/admin_helpers/add-document/' + vendorparts_id + '/', 
                        type: 'GET',
                        success: function(response) {
                            console.log('Received response:', response); 
                            
                            var documentTypeSelect = $('#document_type');
                            documentTypeSelect.empty();
                    
                            response.available_document_types.forEach(function(docType) {
                                console.log('Adding document type to dropdown:', docType); 
                                documentTypeSelect.append(new Option(docType, docType));
                            });
                        },
                        error: function(error) {
                            console.error('Error fetching document types:', error); 
                        }
                    });
                });

            //========================================================================================================================================
                
                $(document).on('click', '.delete-document', function(e) {
                //$('.delete-document').click(function(e) {
                    e.preventDefault(); 
            
                    swal({
                        title: "Are you sure?",
                        text: "You won't be able to revert this!",
                        icon: "warning",
                        buttons: {
                            confirm: {
                                text: "Yes, delete it!",
                                className: "btn btn-success",
                            },
                            cancel: {
                                visible: true,
                                className: "btn btn-danger",
                            },
                        },
                    }).then((Delete) => {
                        if (Delete) {
                            $('#loading-indicator').show();
                            var partDocumentId = $('#edit_document_id').val();

                            console.log('partDocumentId: ', partDocumentId);
                            
                            var url = '/parts/delete_part_document/' + partDocumentId + '/'; 
                
                            $.ajax({
                                url: url,
                                type: 'POST', 
                                data: {
                                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                                },
                                success: function(response) {
                                    setTimeout(function() {
                                        $('#loading-indicator').hide();
                
                                        swal({
                                            title: "Deleted!",
                                            text: "Associated document has been deleted.",
                                            icon: "success",
                                            buttons: {
                                                confirm: {
                                                    className: "btn btn-success",
                                                },
                                            },
                                            timer: 3000 
                                        }).then(() => {
                                            location.reload(); 
                                        });
                                    }, 500); 
                                },
                                error: function(xhr, status, error) {
                                    $('#loading-indicator').hide();
                                    swal({
                                        title: "Error",
                                        text: "An error occurred while trying to delete the document.",
                                        icon: "error",
                                        buttons: {
                                            confirm: {
                                                className: "btn btn-danger",
                                            },
                                        },
                                    });
                                },
                                complete: function() {
                                    setTimeout(function() {
                                        $('#loading-indicator').hide();
                                    }, 3000); 
                                },
                            });
                        } else {
                            swal.close(); 
                        }
                    });
                });
            //========================================================================================================================================
              
                $(document).on('click', '.document.has-file', function() {
                    var documentType = $(this).data('type');
                    var documents = $(this).data('documents');
                    var vendorId = $(this).closest('.vendor-checklist').find('.form-group').find('label').attr('for').split('_')[1];
                    var vendorName = $(this).data('vendor-name');
                    var partDocumentId = $(this).data('partdocument-id');

                    console.log('partDocumentId: ', partDocumentId);
                    console.log('vendorName: ', vendorName);

                    var documentToEdit = documents.find(doc => doc.type === documentType);
                    var documentId = documentToEdit ? documentToEdit.id : null;
                
                    // Populate the edit modal with document details
                    $('#edit_vendor_id').val(vendorId);
                    $('#edit_document_type').val(documentType);
                    //$('#edit_vendor_select_for_docs_modal').val(vendorId); // Set this appropriately
                    $('#edit_document_id').val(documentId); // Assuming you have a hidden field to store the document ID

                    // Clear previous file list
                    $('#edit_fileListContainer').empty();
            
                    // Add the file names to the modal
                    documents.forEach(function(doc) {
                        $('#edit_fileListContainer').append(
                            `<div class="file-item">
                                <span>${doc.file}</span>
                            </div>`
                        );
                    });
                    

                    var editVendorSelect = $('#edit_vendor_select_for_docs_modal');
                    editVendorSelect.empty();
                    editVendorSelect.append(new Option(vendorName, vendorName, true, true));

                    var editDocumentTypeSelect = $('#edit_document_type');
                    editDocumentTypeSelect.empty();

                    if (documentType) {
                        editDocumentTypeSelect.append(new Option(documentType, documentType, true, true));
                    }

                    // Show the edit modal
                    //$('#edit-document-modal').modal('show');
                    $('#delete-confirmation-modal').modal('show');

                });
            //========================================================================================================================================

                $("#main_table").DataTable({
                    dom: '<"float-start"f>',
                    aLengthMenu: [
                        [10, 25, 50, 100, 200, -1],
                        [10, 25, 50, 100, 200, "All"]
                    ],
                    iDisplayLength: -1,
                    searching: true,
                    paging: false,
                    order: [],
                    ordering: true,
                    colResize: {
                        isEnabled: true,
                        hoverClass: 'dt-colresizable-hover',
                        hasBoundCheck: true,
                        minBoundClass: 'dt-colresizable-bound-min',
                        maxBoundClass: 'dt-colresizable-bound-max',
                        saveState: true,
                    },
                });

                $('#main_table_info').addClass('d-none');

            //========================================================================================================================================

                $('#add-ingredients-modal').on('show.bs.modal', function (event) {

                    var button = $(event.relatedTarget);

                    var dataType = button.data('type');
                    
                    var modal = $(this);
                    modal.find('#type').val(dataType);
                    modal.find('#header-type').text(dataType);
                });

            //========================================================================================================================================
               
                $('#add-ingredients').on('submit', function(e) {
                    e.preventDefault(); // Prevent the form from submitting the traditional way
                    
                    var formData = {
                        'part_id': $('#partId_inci').val(),
                        'ingredients': $('#ingredients').val(),
                        'type': $('#type').val(),
                        'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val()
                    };

                    $('#loading-indicator').show();

                    $.ajax({
                        type: 'POST',
                        url: '{% url "add_part_ingredients" %}',
                        data: formData,
                        success: function(response) {
                            swal("Success!", " Ingredient succesfully added", {
                                icon: "success",
                                buttons: {
                                    confirm: {
                                        className: "btn btn-success",
                                    },
                                },
                            }).then(() => {
                                setTimeout(function() {
                                    location.reload(); 
                                }, 1000); 
                            });
                        },
                        error: function(xhr, errmsg, err) {
                            $('#loading-indicator').hide();
                            swal({
                                title: "Error",
                                text: "An error occurred while trying to delete the ingredient.",
                                icon: "error",
                                buttons: {
                                    confirm: {
                                        className: "btn btn-danger",
                                    },
                                },
                            }).then(() => {
                                setTimeout(function() {
                                    location.reload(); 
                                }, 1000); 
                            });
                        }
                    });
                });

            //========================================================================================================================================

                $(document).on('click', '.delete_ingredients', function() {
                    var button = $(this);
                    var container = button.closest('.delete-part-ingredients');
                    var partId = container.data('part-id');
                    var ingredientId = container.data('ingredient-id');
                
                    $('#loading-indicator').show(); 

                    $.ajax({
                        url: "{% url 'delete_ingredients' 0 %}".replace('/0/', '/' + ingredientId + '/'),
                        type: 'POST',
                        data: {
                            csrfmiddlewaretoken: '{{ csrf_token }}',
                        },
                        success: function(response) {
                            container.closest('tr').remove();
                            setTimeout(function() {
                                $('#loading-indicator').hide();
        
                                swal({
                                    title: "Deleted!",
                                    text: "Ingredient removed",
                                    icon: "success",
                                    buttons: {
                                        confirm: {
                                            className: "btn btn-success",
                                        },
                                    },
                                    timer: 3000 
                                }).then(() => {
                                    location.reload(); 
                                });
                            }, 500); 
                        },
                        error: function(xhr, status, error) {
                            console.error("Failed to delete: " + error);
                            swal({
                                title: "Error",
                                text: "An error occurred while trying to delete the ingredient.",
                                icon: "error",
                                buttons: {
                                    confirm: {
                                        className: "btn btn-danger",
                                    },
                                },
                            });
                        },
                        complete: function() {
                            setTimeout(function() {
                                $('#loading-indicator').hide();
                            }, 3000); 
                        }
                    });
                });
                            
        });

            
    </script>
    
    <style>
        
        #vendor-document-checklists {
            overflow-y: auto;
            max-height: 500px;
        }

        #main_table {
            width: 100%;
            table-layout: fixed;
        }

        #main_table td {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        #main_table tbody tr.selected-row {
            background-color: #f2f2f2 !important;
        }

        .main_table {
            overflow-y: auto;
            max-height: 730px;
        }
        
        #main_table_wrapper {
            width: 100%;
        }

        #main_table thead th {
            background-color: #F2F2F2;
            white-space: nowrap;
        }

        #main_table thead th,
        #main_table tbody td,
        #main_table tbody td span {
            margin: 0;
            padding: 0; 
        }

        #main_table thead th, 
        #main_table tbody td {
            font-size: 12px;
        }

        #main_table_filter {
            padding: 10px;
        }
        
        .vendor-table {
            overflow-y: auto;
            max-height: 550px;
        }

        #vendor-table thead th {
            background-color: #F2F2F2;
            white-space: nowrap;
        }

        #vendor-table thead th span {
            font-size: 12px;
        }

        #technical-table thead th {
            background-color: #F2F2F2;
            white-space: nowrap;
        }

        #document-table thead th {
            background-color: #F2F2F2;
        }

        .documents {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .document {
            text-align: center;
            width: 18%;
            padding: 20px;
        }

        .document p {
            margin-top: 10px;
        }

        .document div {
            width: 50px;
            height: 50px;
            border: 1px solid #ccc;
            margin: 0 auto;
            background-color: white;
        }

    </style>
{% endblock %}
